"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));function _createForOfIteratorHelper(a){if("undefined"==typeof Symbol||null==a[Symbol.iterator]){if(Array.isArray(a)||(a=_unsupportedIterableToArray(a))){var b=0,c=function(){};return{s:c,n:function n(){return b>=a.length?{done:!0}:{done:!1,value:a[b++]}},e:function e(a){throw a},f:c}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d,e,f=!0,g=!1;return{s:function s(){d=a[Symbol.iterator]()},n:function n(){var a=d.next();return f=a.done,a},e:function e(a){g=!0,e=a},f:function f(){try{f||null==d["return"]||d["return"]()}finally{if(g)throw e}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(c):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var qiniu=require("qiniu"),fs=require("fs"),crypto=require("crypto"),findCacheDir=require("find-cache-dir"),chalk=require("chalk"),ora=require("ora"),defaultOptions={timeout:6e5,include:[],exclude:[],refresh:!1,refreshFilters:[],delete:!1,prefix:"",chunkSize:2},MAX_REFRESH=100,MAX_DELETE=1e3,MAX_UPLOAD=20,UPLOAD=Symbol("uploading"),DELETE=Symbol("delete"),REFRESH=Symbol("refrsh"),getOptions=function(a){var b=Number.isInteger,c=Object.assign({},defaultOptions,a);if(!a.accessKey)throw new Error("accessKey is required");if(!a.secretKey)throw new Error("secretKey is required");if(!a.cdn)throw new Error("cdn is required");if(!a.zone)throw new Error("zone is required");if(b(a.timeout)&&(c.timeout=a.timeout),Array.isArray(a.exclude)||(c.exclude=[]),Array.isArray(a.include)||(c.include=[]),Array.isArray(a.refreshFilters)&&(c.refreshFilters=[]),"boolean"!=typeof a["delete"]&&(c["delete"]=!1),"boolean"!=typeof a.refresh&&(c.refresh=!1),!a.cdn.startsWith("https://")&&!a.cdn.startsWith("http://"))throw new Error("cdn: \"".concat(a.cdn,"\" must have http or https prefix"));return a.cdn.endsWith("/")||(c.cdn+="/"),a.prefix&&!a.prefix.endsWith("/")&&(c.prefix=a.prefix+"/"),c},initData=function(a){var b=new qiniu.conf.Config;return b.zone=qiniu.zone[a.zone],qiniu.conf.RPC_TIMEOUT=a.timeout,{config:b}},uptoken=function(a,b,c){var d=new qiniu.rs.PutPolicy({scope:b+":"+c});return d.uploadToken(a)},getFileHash=function(a){return new Promise(function(b,c){var d=crypto.createHash("md5"),e=fs.createReadStream(a.existsAt);e.on("data",d.update.bind(d)),e.on("end",function(){var a=d.digest("hex");b(a)}),e.on("error",function(a){c(a)})})},needUpload=function(a,b){return a!==b};function mkdirsSync(a){fs.existsSync(a)||fs.mkdirSync(a,{recursive:!0})}function loadCacheData(){var a=findCacheDir({name:"simple-cdn-webpack-plugin",create:!0}),b=a+"/cacheData.json";if(fs.existsSync(b)){var c=fs.readFileSync(b);return JSON.parse(c)||{}}return{}}function writeCache(a){var b=findCacheDir({name:"simple-cdn-webpack-plugin",create:!0});fs.writeFileSync(b+"/cacheData.json",JSON.stringify(a))}function filterArray(a,b){var c=!(2<arguments.length&&arguments[2]!==void 0)||arguments[2];return 0===a.length?b:(0,_toConsumableArray2["default"])(b).filter(function(b){var d=a.some(function(a){return"string"==typeof a?b===a:"function"==typeof a?a(b):!!(a instanceof RegExp)&&a.test(b)});return c?d:!d})}function chunkArray(a,b){for(var c=Math.floor,d=c(a.length/b),e=[],f=0;f<d;f+b)e.push(a.slice(f,f+b));return e.push(a.slice(d*b)),e||[]}var spinner=ora({color:"green"}),spinning=function(a){var b=a.done,c=void 0===b?0:b,d=a.total,e=a.type,f=void 0===e?UPLOAD:e;f===UPLOAD?spinner.text=d?"uploading ".concat(c,"/").concat(d):"wait for uploading...":f===DELETE?spinner.text=d?"deleting ".concat(c,"/").concat(d):"wait for deleting...":f===REFRESH?spinner.text=d?"refreshing ".concat(c,"/").concat(d):"wait for refreshing...":void 0;0===c&&spinner.start(),c===d&&spinner.succeed()},spinFail=function(a){spinner.fail(a)},Upload=function(){function a(b){(0,_classCallCheck2["default"])(this,a),this.options=getOptions(b);var c=initData(this.options),d=c.config;this.config=d,this.cacheData=loadCacheData(),this.failedData={}}return(0,_createClass2["default"])(a,[{key:"createMac",value:function createMac(){return new qiniu.auth.digest.Mac(this.options.accessKey,this.options.secretKey)}},{key:"apply",value:function apply(a){var b=this;a.plugin("after-emit",function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(c,d){var e,f,g,h,i,j,k,l,m,n,o;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return console.log("\n"),console.log(chalk.blue("simple-cdn-webpacl-plugin start...")),e=c.assets,f=filterArray(b.options.exclude,filterArray(b.options.include,Object.keys(e).filter(function(a){return e[a].emitted})),!1),g={},h=function(a){return b.options.prefix?b.options.prefix+a:a},i=function(a){var c=e[a],d=h(a),f=uptoken(b.createMac(),b.options.bucket,d),g=new qiniu.form_up.FormUploader(b.config),i=new qiniu.form_up.PutExtra;return new Promise(function(b,e){return g.putFile(f,d,c.existsAt,i,function(c,d,f){c?(console.log(chalk.red(a)+": upload failed"),console.error(c),e(c)):200==f.statusCode?b():(console.log(chalk.red("upload failed")),e(d))})})},j=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e,f,g;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:console.log("".concat(chalk.blue(b.length)," files need to upload")),c=0,d=b.length,spinning({done:c,total:d,UPLOAD:UPLOAD}),e=_createForOfIteratorHelper(b),a.prev=5,e.s();case 7:if((f=e.n()).done){a.next=22;break}return g=f.value,a.prev=9,a.next=12,i(g);case 12:a.next=18;break;case 14:return a.prev=14,a.t0=a["catch"](9),spinFail("upload file: ".concat(g," failed")),a.abrupt("return",Promise.reject(a.t0));case 18:c++,spinning({done:c,total:d,UPLOAD:UPLOAD});case 20:a.next=7;break;case 22:a.next=27;break;case 24:a.prev=24,a.t1=a["catch"](5),e.e(a.t1);case 27:return a.prev=27,e.f(),a.finish(27);case 30:return console.log(chalk.blue("upload files success")),a.abrupt("return",Promise.resolve());case 32:case"end":return a.stop();}},a,null,[[5,24,27,30],[9,14]])}));return function(){return a.apply(this,arguments)}}(),k=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,new Promise(function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(c,d){var i,j;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,Promise.all(f.map(function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,getFileHash(e[b]);case 2:return c=a.sent,a.abrupt("return",{fileName:b,hash:c});case 4:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}()));case 3:i=a.sent,j=[],i.map(function(a){var c=h(a.fileName);g[c]=a.hash,needUpload(a.hash,b.cacheData[c])&&j.push(a.fileName)}),c(j),a.next=12;break;case 9:a.prev=9,a.t0=a["catch"](0),d();case 12:case"end":return a.stop();}},a,null,[[0,9]])}));return function(){return a.apply(this,arguments)}}());case 2:return a.abrupt("return",a.sent);case 3:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),a.next=11,k();case 11:l=a.sent,m=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var c,d,e,f,h,i,j,k,l,m;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b.options["delete"]){a.next=2;break}return a.abrupt("return",Promise.resolve());case 2:if(c=Object.keys(b.cacheData),d=c.filter(function(a){return!g[a]||g[a]!==b.cacheData[a]}),console.log("".concat(chalk.blue(d.length)," files need to delete")),e=d.length,0!==e){a.next=8;break}return a.abrupt("return",Promise.resolve());case 8:f=function(a){return qiniu.rs.deleteOp(b.options.bucket,a)},h=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=new qiniu.rs.BucketManager(b.createMac(),b.config),a.abrupt("return",new Promise(function(a,b){d.batch(c,function(c,d,e){c?b(c):2==parseInt(e.statusCode/100)?a():b(d)})}));case 2:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),i=chunkArray(d,MAX_REFRESH),j=0,spinning({done:j,total:e,DELETE:DELETE}),k=_createForOfIteratorHelper(i),a.prev=14,k.s();case 16:if((l=k.n()).done){a.next=31;break}return m=l.value,a.prev=18,a.next=21,h(m.map(function(a){return f(a)}));case 21:a.next=27;break;case 23:return a.prev=23,a.t0=a["catch"](18),spinFail("delete file failed"),a.abrupt("return",Promise.reject(a.t0));case 27:j+=m.length,spinning({done:j,total:e,DELETE:DELETE});case 29:a.next=16;break;case 31:a.next=36;break;case 33:a.prev=33,a.t1=a["catch"](14),k.e(a.t1);case 36:return a.prev=36,k.f(),a.finish(36);case 39:return a.abrupt("return",Promise.resolve());case 40:case"end":return a.stop();}},a,null,[[14,33,36,39],[18,23]])}));return function(){return a.apply(this,arguments)}}(),n=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var c,d,e,f,g,i,j,k,m;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b.options.refresh){a.next=2;break}return a.abrupt("return",Promise.resolve());case 2:if(c=new qiniu.cdn.CdnManager(b.createMac()),d=filterArray(b.options.refreshFilters,(0,_toConsumableArray2["default"])(l)).map(function(a){return"".concat(b.options.cdn).concat(h(a))}),console.log("".concat(chalk.blue(d.length)," files need to refresh")),e=d.length,0!==e){a.next=8;break}return a.abrupt("return",Promise.resolve());case 8:f=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(function(a,d){c.refreshUrls(b,function(b,c,e){b?d(b):200==e.statusCode?((200===c.code||"success"===c.error)&&a(),d({message:"refresh error",respBody:c})):d(c)})}));case 1:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),g=chunkArray(d,MAX_DELETE),i=0,spinning({done:i,total:e,REFRESH:REFRESH}),j=_createForOfIteratorHelper(g),a.prev=13,j.s();case 15:if((k=j.n()).done){a.next=30;break}return m=k.value,a.prev=17,a.next=20,f(m);case 20:a.next=26;break;case 22:return a.prev=22,a.t0=a["catch"](17),spinFail("delete file failed"),a.abrupt("return",Promise.reject(a.t0));case 26:i+=m.length,spinning({done:i,total:e,REFRESH:REFRESH});case 28:a.next=15;break;case 30:a.next=35;break;case 32:a.prev=32,a.t1=a["catch"](13),j.e(a.t1);case 35:return a.prev=35,j.f(),a.finish(35);case 38:return a.abrupt("return",Promise.resolve());case 39:case"end":return a.stop();}},a,null,[[13,32,35,38],[17,22]])}));return function(){return a.apply(this,arguments)}}(),o=function(){console.log(chalk.blue("files successfully uploaded to Qiniu Cloud cdn!")),d()},j(l).then(function(){return m()}).then(function(){return n()}).then(function(){return writeCache(g)}).then(function(){return o()})["catch"](function(a){d(a)});case 16:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}())}}]),a}();module.exports=Upload;
