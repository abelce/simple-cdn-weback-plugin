"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),qiniu=require("qiniu"),fs=require("fs"),crypto=require("crypto"),findCacheDir=require("find-cache-dir"),chalk=require("chalk"),defaultOptions={timeout:6e5,include:[],exclude:[],refresh:!1,refreshFilters:[],delete:!1},MAX_REFRESH=100,MAX_DELETE=1e3,getOptions=function(a){var b=Number.isInteger,c=Object.assign({},defaultOptions,a);if(!a.accessKey)throw new Error("accessKey is required");if(!a.secretKey)throw new Error("secretKey is required");if(!a.cdn)throw new Error("cdn is required");if(!a.zone)throw new Error("zone is required");if(b(a.timeout)&&(c.timeout=a.timeout),Array.isArray(a.exclude)||(c.exclude=[]),Array.isArray(a.include)||(c.include=[]),Array.isArray(a.refreshFilters)&&(c.refreshFilters=[]),"boolean"!=typeof a["delete"]&&(c["delete"]=!1),"boolean"!=typeof a.refresh&&(c.refresh=!1),!a.cdn.endsWith("https://")||!a.cdn.endsWith("http://"))throw new Error("cdn: \"".concat(a.cdn,"\" must have http or https prefix"));return a.cdn.endsWith("/")||(c.cdn+="/"),c},initData=function(a){var b=new qiniu.conf.Config;return b.zone=qiniu.zone[a.zone],qiniu.conf.RPC_TIMEOUT=a.timeout,{config:b}},uptoken=function(a,b,c){var d=new qiniu.rs.PutPolicy({scope:b+":"+c});return d.uploadToken(a)},getFileHash=function(a){return new Promise(function(b,c){var d=crypto.createHash("md5"),e=fs.createReadStream(a.existsAt);e.on("data",d.update.bind(d)),e.on("end",function(){var a=d.digest("hex");b(a)}),e.on("error",function(a){c(a)})})},needUpload=function(a,b){return a!==b};function mkdirsSync(a){fs.existsSync(a)||fs.mkdirSync(a,{recursive:!0})}function loadCacheData(){var a=findCacheDir({name:"sQiNiu",create:!0}),b=a+"/cacheData.json";if(fs.existsSync(b)){var c=fs.readFileSync(b);return JSON.parse(c)||{}}return{}}function writeCache(a){var b=findCacheDir({name:"sQiNiu",create:!0});fs.writeFileSync(b+"/cacheData.json",JSON.stringify(a))}function filterArray(a,b){var c=!(2<arguments.length&&arguments[2]!==void 0)||arguments[2];return 0===a.length?b:(0,_toConsumableArray2["default"])(b).filter(function(b){var d=a.some(function(a){return"string"==typeof a?b===a:"function"==typeof a?a(b):!!(a instanceof RegExp)&&a.test(b)});return c?d:!d})}function chunkArray(a,b){for(var c=Math.floor,d=c(a.length/b),e=[],f=0;f<d;f+b)e.push(a.slice(f,f+b));return e.push(a.slice(d*b)),e||[]}var Upload=function(){function a(b){(0,_classCallCheck2["default"])(this,a),this.options=getOptions(b);var c=initData(this.options),d=c.config;this.config=d,this.cacheData=loadCacheData(),this.failedData={}}return(0,_createClass2["default"])(a,[{key:"createMac",value:function createMac(){return new qiniu.auth.digest.Mac(this.options.accessKey,this.options.secretKey)}},{key:"apply",value:function apply(a){var b=this;a.plugin("after-emit",function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(c){var d,e,f,g,h,i,j,k,l,m;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=c.assets,e=filterArray(b.options.exclude,filterArray(b.options.include,Object.keys(d).filter(function(a){return d[a].emitted})),!1),f={},g=function(a){var c=d[a],e=uptoken(b.createMac(),b.options.bucket,a),f=new qiniu.form_up.FormUploader(b.config),g=new qiniu.form_up.PutExtra;return new Promise(function(b,d){return f.putFile(e,a,c.existsAt,g,function(c,e,f){c?(console.log(chalk.red(a)+": upload failed"),console.error(c),d(c)):200==f.statusCode?b():(console.log("upload failed"),d(e))})})},h=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(c){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return console.log("".concat(chalk.blue(c.length)," files need to upload")),a.next=3,c.map(function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(c){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,g(c)["catch"](function(){b.failedData[c]=!0});case 2:return a.abrupt("return",a.sent);case 3:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}());case 3:return a.abrupt("return",a.sent);case 4:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),i=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,new Promise(function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(c,g){var h,i;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,Promise.all(e.map(function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,getFileHash(d[b]);case 2:return c=a.sent,a.abrupt("return",{fileName:b,hash:c});case 4:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}()));case 3:h=a.sent,i=[],h.map(function(a){f[a.fileName]=a.hash,needUpload(a.hash,b.cacheData[a.fileName])&&i.push(a.fileName)}),c(i),a.next=12;break;case 9:a.prev=9,a.t0=a["catch"](0),g();case 12:case"end":return a.stop();}},a,null,[[0,9]])}));return function(){return a.apply(this,arguments)}}());case 2:return a.abrupt("return",a.sent);case 3:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),a.next=8,i();case 8:j=a.sent,k=function(){if(!b.options["delete"])return Promise.resolve();var a=Object.keys(b.cacheData),c=a.filter(function(a){return!f[a]||f[a]!==b.cacheData[a]});if(console.log("".concat(chalk.blue(c.length)," files need to delete")),0===c.length)return Promise.resolve();var d=function(a){return qiniu.rs.deleteOp(b.options.bucket,a)},e=function(a){var c=new qiniu.rs.BucketManager(b.createMac(),b.config);return new Promise(function(b,d){c.batch(a,function(a,c,e){a?d(a):2==parseInt(e.statusCode/100)?b():d(c)})})},g=chunkArray(c,MAX_REFRESH);return Promise.all(g.map(function(a){return e(a.map(function(a){return d(a)}))}))},l=function(){if(!b.options.refresh)return Promise.resolve();var a=new qiniu.cdn.CdnManager(b.createMac()),c=filterArray(b.options.refreshFilters,(0,_toConsumableArray2["default"])(j)).map(function(a){return"".concat(b.options.cdn).concat(a)});if(console.log("".concat(chalk.blue(c.length)," files need to refresh")),0===c.length)return Promise.resolve();var d=function(b){return new Promise(function(c,d){a.refreshUrls(b,function(a,b,e){a?d(a):200==e.statusCode?((200===b.code||"success"===b.error)&&c(),d({message:"refresh error",respBody:b})):d(b)})})},e=chunkArray(needDeleteFiles,MAX_DELETE);return Promise.all(e.map(function(a){return d(a)}))},m=function(){console.log(chalk.blue("files successfully uploaded to Qiniu Cloud cdn!"))},h(j).then(function(){return k()}).then(function(){return l()}).then(function(){return writeCache(f)}).then(function(){return m()})["catch"](function(a){throw console.error(a),new Error(a)});case 13:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}())}}]),a}();module.exports=Upload;
